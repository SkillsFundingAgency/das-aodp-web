using AutoFixture;
using Azure;
using Azure.Storage.Blobs;
using Azure.Storage.Blobs.Models;
using Microsoft.Extensions.Options;
using Moq;
using SFA.DAS.AODP.Infrastructure.File;
using SFA.DAS.AODP.Models.Settings;

namespace SFA.DAS.AODP.Infrastructure.UnitTests.File
{
    public class BlobStorageFileService_MalwareTests
    {
        private readonly Fixture _fixture = new();
        private readonly BlobStorageFileService _sut;
        private readonly Mock<BlobServiceClient> _blobServiceClient = new();

        public BlobStorageFileService_MalwareTests()
        {
            var blobSettings = _fixture.Create<BlobStorageSettings>();
            var importSettings = _fixture.Create<ImportBlobStorageSettings>();

            var clientFactoryMock = new Mock<Microsoft.Extensions.Azure.IAzureClientFactory<BlobServiceClient>>();
            clientFactoryMock
                .Setup(factory => factory.CreateClient(It.IsAny<string>()))
                .Returns(_blobServiceClient.Object);

            var formBuilderSettings = new FormBuilderSettings
            {
                MaxUploadFileSize = 10,
                UploadFileTypesAllowed = new List<string> { ".docx" }
            };

            _sut = new BlobStorageFileService(
                _blobServiceClient.Object,
                clientFactoryMock.Object,
                Options.Create(blobSettings),
                Options.Create(importSettings),
                formBuilderSettings);
        }

        [Theory]
        [InlineData(BlobStorageFileService.MalwareScanCleanValue, MalwareScanStatus.Clean)]
        [InlineData(BlobStorageFileService.MalwareScanMaliciousValue, MalwareScanStatus.Malicious)]
        [InlineData(BlobStorageFileService.MalwareScanErrorValue, MalwareScanStatus.Error)]
        [InlineData(BlobStorageFileService.MalwareScanNotScannedValue, MalwareScanStatus.InProgress)]
        public void MapScanStatus_MapsKnownValues(string input, MalwareScanStatus expected)
        {
            var result = BlobStorageFileService.MapScanStatus(input);
            Assert.Equal(expected, result);
        }

        [Theory]
        [InlineData(null)]
        [InlineData("")]
        [InlineData("   ")]
        [InlineData("UnexpectedValue")]
        public void MapScanStatus_ReturnsUnknown_ForInvalidValues(string input)
        {
            var result = BlobStorageFileService.MapScanStatus(input);
            Assert.Equal(MalwareScanStatus.Unknown, result);
        }

        [Fact]
        public void TryGetScanStatus_ReturnsInProgress_WhenNoTagsPresent()
        {
            var blobClient = new Mock<BlobClient>();

            var emptyTagsResult = BlobsModelFactory.GetBlobTagResult(
                tags: new Dictionary<string, string>());

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Returns(Response.FromValue(emptyTagsResult, Mock.Of<Response>()));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.InProgress, result);
        }

        [Fact]
        public void TryGetScanStatus_ReturnsInProgress_WhenTagEmpty()
        {
            var blobClient = new Mock<BlobClient>();

            var tagsResult = BlobsModelFactory.GetBlobTagResult(
                tags: new Dictionary<string, string>
                {
                    { BlobStorageFileService.MalwareScanResultTagKey, "" }
                });

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Returns(Response.FromValue(tagsResult, Mock.Of<Response>()));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.InProgress, result);
        }

        [Fact]
        public void TryGetScanStatus_ReturnsClean()
        {
            var blobClient = new Mock<BlobClient>();

            var tagsResult = BlobsModelFactory.GetBlobTagResult(
                tags: new Dictionary<string, string>
                {
                    { BlobStorageFileService.MalwareScanResultTagKey, BlobStorageFileService.MalwareScanCleanValue }
                });

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Returns(Response.FromValue(tagsResult, Mock.Of<Response>()));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.Clean, result);
        }

        [Fact]
        public void TryGetScanStatus_ReturnsMalicious()
        {
            var blobClient = new Mock<BlobClient>();

            var tagsResult = BlobsModelFactory.GetBlobTagResult(
                tags: new Dictionary<string, string>
                {
                    { BlobStorageFileService.MalwareScanResultTagKey, BlobStorageFileService.MalwareScanMaliciousValue }
                });

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Returns(Response.FromValue(tagsResult, Mock.Of<Response>()));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.Malicious, result);
        }

        [Fact]
        public void TryGetScanStatus_ReturnsError()
        {
            var blobClient = new Mock<BlobClient>();

            var tagsResult = BlobsModelFactory.GetBlobTagResult(
                tags: new Dictionary<string, string>
                {
                    { BlobStorageFileService.MalwareScanResultTagKey, BlobStorageFileService.MalwareScanErrorValue }
                });

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Returns(Response.FromValue(tagsResult, Mock.Of<Response>()));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.Error, result);
        }

        [Fact]
        public void TryGetScanStatus_MapsNotScanned_AsInProgress()
        {
            var blobClient = new Mock<BlobClient>();

            var tagsResult = BlobsModelFactory.GetBlobTagResult(
                tags: new Dictionary<string, string>
                {
                    { BlobStorageFileService.MalwareScanResultTagKey, BlobStorageFileService.MalwareScanNotScannedValue }
                });

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Returns(Response.FromValue(tagsResult, Mock.Of<Response>()));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.InProgress, result);
        }

        [Fact]
        public void TryGetScanStatus_ReturnsUnknown_WhenGetTagsThrows()
        {
            var blobClient = new Mock<BlobClient>();

            blobClient.Setup(b => b.GetTags(
                    It.IsAny<BlobRequestConditions?>(),
                    It.IsAny<CancellationToken>()
                ))
                .Throws(new Exception("boom"));

            var result = _sut.TryGetScanStatus(blobClient.Object);

            Assert.Equal(MalwareScanStatus.Unknown, result);
        }
    }
}